
<!DOCTYPE html>
<html>
<head>
    <title>TC-Link-200 Configurator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; font-family: sans-serif; }
        .card { margin-bottom: 20px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .status-ok { color: #2ecc71; font-weight: bold; }
        .status-err { color: #e74c3c; font-weight: bold; }
        .status-warn { color: #d39e00; font-weight: bold; }
        .diag-text { font-size: 0.74rem; color: #6c757d; line-height: 1.35; }
        .log-box { font-family: monospace; font-size: 0.8rem; background: #0b1020; color: #b9c2ff; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto; }
        .status-pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.8rem; }
        .status-ok-pill { background: #dff6e8; color: #1f7a3f; }
        .status-err-pill { background: #fde2e1; color: #b3261e; }
        .base-status-text { white-space: pre-line; }
        .channel-picker { position: relative; max-width: 280px; }
        .channel-summary-btn { width: 100%; text-align: left; }
        .channel-menu { position: absolute; top: calc(100% + 4px); left: 0; right: 0; z-index: 10; background: #fff; border: 1px solid #ced4da; border-radius: 6px; padding: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); display: none; }
        .channel-menu.open { display: block; }
        .channel-row { display: flex; align-items: center; gap: 8px; padding: 4px 2px; }
        .node-actions { gap: 0.35rem !important; flex-wrap: nowrap; }
        .node-actions .btn {
            padding: 0.12rem 0.35rem;
            font-size: 0.58rem;
            min-height: 24px;
            line-height: 1;
            white-space: nowrap;
            width: auto !important;
            flex: 0 0 auto;
        }
    </style>
</head>
<body>
<div class="container" style="max-width: 800px;">
    <div class="card p-3 shadow-sm bg-primary text-white d-flex flex-row justify-content-between align-items-center">
        <h4 class="m-0">üì° –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä TC-Link-200</h4>
    </div>

    <div class="card p-4 shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <div class="fw-bold">BaseStation</div>
                <div id="baseStatusText" class="small text-muted base-status-text">Status: Unknown</div>
            </div>
            <div class="d-flex gap-2">
                <button onclick="connectBase()" class="btn btn-outline-secondary btn-sm fw-bold">üîå Connect</button>
                <button id="btnBeacon" onclick="toggleBeacon()" class="btn btn-outline-info btn-sm fw-bold">Beacon: ?</button>
                <span class="text-muted align-self-center" title="Beacon ON keeps node sync/communication active. Beacon OFF is only for diagnostics/isolation and may make nodes unreachable.">‚ìò</span>
            </div>
        </div>
        <div id="baseStatusPill" class="status-pill status-err-pill mb-3">Disconnected</div>

        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text">Node ID</span>
                    <input type="number" id="nodeId" class="form-control" value="16907">
                </div>
            </div>
            <div class="col-md-8 d-flex gap-2 node-actions">
                <button id="btnRead" onclick="readConfig()" class="btn btn-success fw-bold">READ</button>
                <button id="btnSetIdle" onclick="setNodeIdle()" class="btn btn-outline-primary fw-bold">Set to Idle</button>
                <button id="btnCyclePower" onclick="cycleNodePower()" class="btn btn-outline-primary fw-bold">Power Cycle</button>
                <button id="btnClearStorage" onclick="clearStorage()" class="btn btn-outline-danger fw-bold" disabled>Clear Storage</button>
                <button id="btnProbe" onclick="probeNode()" class="btn btn-outline-secondary fw-bold">üõ∞Ô∏è PROBE</button>
            </div>
        </div>
        <div id="readStatus" class="mt-2 text-center fw-bold small"></div>
        <div class="small text-muted mt-3 p-2 bg-light rounded">
            <div class="fw-bold text-primary mb-1">Recommended Workflow</div>
            <div>1. Set to Idle</div>
            <div>2. Read</div>
            <div>3. Before write: Set to Idle -> Safe Write</div>
            <div>4. Use Power Cycle only for recovery</div>
        </div>
    </div>

    <div id="configCard" style="display:none;">
        <div class="card p-4 shadow-sm">
            <div class="fw-bold text-primary mb-3">
                Node Settings
                <span class="ms-2 text-muted" title="LED quick guide: Green pulse = Idle. Single green blink every ~2s = Sampling. Blue during sampling = resynchronizing. Red = self-test error. Off = powered down.">‚ìò</span>
            </div>
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold">–ß–∞—Å—Ç–æ—Ç–∞ (Sample Rate)</label>
                    <select id="sampleRate" class="form-select"></select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">–ú–æ—â–Ω–æ—Å—Ç—å —Ä–∞–¥–∏–æ</label>
                    <select id="txPower" class="form-select">
                        <option value="16">16 dBm</option>
                        <option value="10">10 dBm</option>
                        <option value="5">5 dBm</option>
                        <option value="0">0 dBm (Min)</option>
                    </select>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Input Range</label>
                    <select id="inputRange" class="form-select">
                        <option value="">N/A</option>
                    </select>
                </div>
            </div>

            <label class="form-label fw-bold text-primary">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (Raw Mode):</label>
            <div id="channelsArea" class="mb-4"></div>

            <div class="mb-3">
                <div class="fw-bold text-primary mb-1">Node Status</div>
                <div id="diagArea" class="diag-text p-2 bg-light rounded"></div>
            </div>
            <div class="mb-4">
                <div class="fw-bold text-primary mb-1">Node Diagnostics</div>
                <div id="diagFlags" class="small text-muted"></div>
            </div>

            <button id="btnWrite" onclick="applyConfig(true)" class="btn btn-primary w-100 fw-bold py-2">üõ°Ô∏è SAFE WRITE</button>
            <div id="writeStatus" class="mt-3 text-center fw-bold"></div>
        </div>
    </div>

    <div class="card p-4 shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">MSCL Logs</div>
            <button onclick="refreshLogs()" class="btn btn-outline-secondary btn-sm fw-bold">‚Üª Refresh</button>
        </div>
        <div id="logBox" class="log-box">Logs will appear here‚Ä¶</div>
    </div>
</div>

<script>
    const LAST_COMM_WARN_SEC = 30;
    const LAST_COMM_CRITICAL_SEC = 120;

    async function connectBase() {
        try {
            let res = await fetch('/api/connect', {method:'POST'});
            let data = await res.json();
            if (!data.success) {
                res = await fetch('/api/reconnect', {method:'POST'});
                data = await res.json();
            }
            const statusDiv = document.getElementById('readStatus');
            if (data.success) {
                statusDiv.className = "mt-2 text-center status-ok";
                statusDiv.innerHTML = "‚úÖ Base connected";
            } else {
                statusDiv.className = "mt-2 text-center status-err";
                statusDiv.innerHTML = `‚ùå Base connect failed: ${data.message || data.error || 'Unknown error'}`;
            }
            await refreshBaseStatus();
        } catch (e) { }
    }

    async function readConfig() {
        const id = document.getElementById('nodeId').value;
        const statusDiv = document.getElementById('readStatus');
        const btnRead = document.getElementById('btnRead');
        
        btnRead.disabled = true;
        statusDiv.className = "mt-2 text-center text-primary";
        statusDiv.innerHTML = "‚åõ Reading...";
        document.getElementById('configCard').style.display = "none";
        
        try {
            const res = await fetch(`/api/read/${id}`);
            const data = await res.json();
            if(data.success) {
                statusDiv.className = "mt-2 text-center status-ok";
                statusDiv.innerHTML = "‚úÖ Read complete";
                document.getElementById('configCard').style.display = "block";
                
                document.getElementById('txPower').value = data.current_power;
                const inputSel = document.getElementById('inputRange');
                inputSel.innerHTML = "";
                const inputRanges = Array.isArray(data.supported_input_ranges) ? data.supported_input_ranges : [];
                if (!inputRanges.length) {
                    const opt = document.createElement('option');
                    opt.value = "";
                    opt.text = "N/A";
                    opt.selected = true;
                    inputSel.add(opt);
                } else {
                    inputRanges.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.value;
                        opt.text = r.label || `Value ${r.value}`;
                        if (r.primary) opt.style.fontWeight = "700";
                        if (String(r.value) === String(data.current_input_range)) opt.selected = true;
                        inputSel.add(opt);
                    });
                }
                const selectedInputRangeOpt = inputSel.options[inputSel.selectedIndex];
                const inputRangeActual = selectedInputRangeOpt ? selectedInputRangeOpt.text : "N/A";
                const activeChannelsText = Array.isArray(data.channels)
                    ? data.channels.filter(ch => ch.enabled).map(ch => `ch${ch.id}`).join(", ")
                    : "";
                const stateNonIdle = (data.state !== null && data.state !== undefined) && String(data.state) !== "0";
                const stateText = data.state_text
                    ? `State: ${data.state_text}${(data.state !== null && data.state !== undefined) ? ` (${data.state})` : ''}`
                    : null;
                const lastCommAgeSec = parseLastCommAgeSec(data.last_comm);
                const lastCommWarn = Number.isFinite(lastCommAgeSec) && lastCommAgeSec > LAST_COMM_WARN_SEC && lastCommAgeSec <= LAST_COMM_CRITICAL_SEC;
                const lastCommDanger = Number.isFinite(lastCommAgeSec) && lastCommAgeSec > LAST_COMM_CRITICAL_SEC;
                const lastCommText = data.last_comm
                    ? (lastCommDanger
                        ? `<span class='status-err'>Last Comm: ${data.last_comm} (${Math.round(lastCommAgeSec)}s ago)</span>`
                        : (lastCommWarn
                            ? `<span class='status-warn'>Last Comm: ${data.last_comm} (${Math.round(lastCommAgeSec)}s ago)</span>`
                            : `Last Comm: ${data.last_comm}`))
                    : null;
                const storagePctNum = (data.storage_pct !== null && data.storage_pct !== undefined)
                    ? Number(data.storage_pct)
                    : null;
                const storageDanger = Number.isFinite(storagePctNum) && storagePctNum > 90;
                const storageWarn = Number.isFinite(storagePctNum) && storagePctNum >= 70 && storagePctNum <= 90;
                const statusParts = [
                    `Model: ${data.model}`,
                    `FW: ${data.fw}`,
                    (data.node_address !== null && data.node_address !== undefined) ? `Node Address: ${data.node_address}` : null,
                    lastCommText,
                    stateText ? (stateNonIdle ? `<span class='status-warn'>${stateText}</span>` : stateText) : null,
                    data.comm_protocol_text ? `Comm Protocol: ${data.comm_protocol_text}${(data.comm_protocol !== null && data.comm_protocol !== undefined) ? ` (${data.comm_protocol})` : ''}` : null,
                    data.region ? `Region: ${data.region}` : null,
                    data.frequency ? `Frequency: ${data.frequency}` : null,
                    (data.current_power !== null && data.current_power !== undefined) ? `Radio Power: ${data.current_power} dBm` : null,
                    inputRangeActual ? `Input Range: ${inputRangeActual}` : null,
                    activeChannelsText ? `Active Channels: ${activeChannelsText}` : null,
                    data.sampling_mode ? `Sampling: ${data.sampling_mode}` : null,
                    (data.data_mode && String(data.data_mode) !== "1") ? `Data Mode: ${data.data_mode}` : null,
                    (storagePctNum !== null)
                        ? (storageDanger
                            ? `<span class='status-err'>Storage: ${storagePctNum}%</span>`
                            : (storageWarn
                                ? `<span class='status-warn'>Storage: ${storagePctNum}%</span>`
                                : `Storage: ${storagePctNum}%`))
                        : null
                ].filter(Boolean);
                document.getElementById('diagArea').innerHTML = statusParts.join(" | ");
                await loadDiagnostics(id);

                const sel = document.getElementById('sampleRate');
                sel.innerHTML = "";
                if (data.current_rate === null || data.current_rate === undefined) {
                    let opt = document.createElement('option');
                    opt.value = "";
                    opt.text = "N/A";
                    opt.selected = true;
                    sel.add(opt);
                }
                data.supported_rates.forEach(r => {
                    let opt = document.createElement('option');
                    opt.value = r.enum_val; opt.text = r.str_val;
                    if(r.enum_val == data.current_rate) opt.selected = true;
                    sel.add(opt);
                });

                const chArea = document.getElementById('channelsArea');
                chArea.innerHTML = "";
                chArea.innerHTML = `
                    <div class="channel-picker" id="channelPicker">
                        <button type="button" class="btn btn-outline-secondary channel-summary-btn" id="channelSummaryBtn" onclick="toggleChannelsMenu(event)">
                            0 active
                        </button>
                        <div class="channel-menu" id="channelMenu"></div>
                    </div>
                `;
                const channelNames = {
                    1: "Raw Data (ch1)",
                    2: "CJC Temperature (ch2)"
                };
                const menu = document.getElementById('channelMenu');
                data.channels.forEach(ch => {
                    let checked = ch.enabled ? "checked" : "";
                    const label = channelNames[ch.id] || `Channel ${ch.id}`;
                    menu.innerHTML += `
                        <label class="channel-row">
                            <input class="form-check-input ch-enable" type="checkbox" id="ch_${ch.id}" ${checked} onchange="updateChannelSummary()">
                            <span>${label}</span>
                        </label>
                    `;
                });
                updateChannelSummary();
                document.getElementById('btnClearStorage').disabled = false;
            } else {
                statusDiv.className = "mt-2 text-center status-err";
                statusDiv.innerHTML = "‚ùå –û—à–∏–±–∫–∞: " + data.error;
                document.getElementById('btnClearStorage').disabled = true;
            }
        } finally {
            btnRead.disabled = false;
        }
    }

    function parseLastCommAgeSec(lastCommStr) {
        if (!lastCommStr) return NaN;
        // Expected format from backend: "YYYY-MM-DD HH:MM:SS"
        const iso = String(lastCommStr).replace(" ", "T");
        const dt = new Date(iso);
        if (Number.isNaN(dt.getTime())) return NaN;
        return (Date.now() - dt.getTime()) / 1000;
    }

    async function probeNode() {
        const id = document.getElementById('nodeId').value;
        const statusDiv = document.getElementById('readStatus');
        const btn = document.getElementById('btnProbe');
        btn.disabled = true;
        statusDiv.className = "mt-2 text-center text-primary";
        statusDiv.innerHTML = "üõ∞Ô∏è Probing node...";
        try {
            const res = await fetch(`/api/probe/${id}`);
            const data = await res.json();
            if (data.success) {
                statusDiv.className = "mt-2 text-center status-ok";
                statusDiv.innerHTML = `‚úÖ ${data.message || 'Probe OK'}`;
            } else {
                statusDiv.className = "mt-2 text-center status-err";
                statusDiv.innerHTML = `‚ùå ${data.error || 'Probe failed'}`;
            }
        } catch (e) {
            statusDiv.className = "mt-2 text-center status-err";
            statusDiv.innerHTML = "‚ùå Probe failed";
        } finally {
            btn.disabled = false;
        }
    }

    async function setNodeIdle() {
        const id = document.getElementById('nodeId').value;
        const statusDiv = document.getElementById('readStatus');
        const btn = document.getElementById('btnSetIdle');
        btn.disabled = true;
        statusDiv.className = "mt-2 text-center text-primary";
        statusDiv.innerHTML = "‚è≥ Sending Set to Idle...";
        try {
            const res = await fetch(`/api/node_idle/${id}`, {method:'POST'});
            const data = await res.json();
            if (data.success) {
                statusDiv.className = "mt-2 text-center status-ok";
                statusDiv.innerHTML = "‚úÖ Node set to Idle";
            } else {
                statusDiv.className = "mt-2 text-center status-err";
                statusDiv.innerHTML = `‚ùå ${data.error}`;
            }
        } catch (e) {
            statusDiv.className = "mt-2 text-center status-err";
            statusDiv.innerHTML = "‚ùå Set to Idle failed";
        } finally {
            btn.disabled = false;
        }
    }

    async function cycleNodePower() {
        const id = document.getElementById('nodeId').value;
        const statusDiv = document.getElementById('readStatus');
        const btn = document.getElementById('btnCyclePower');
        btn.disabled = true;
        statusDiv.className = "mt-2 text-center text-primary";
        statusDiv.innerHTML = "‚è≥ Sending Power Cycle...";
        try {
            const res = await fetch(`/api/node_cycle_power/${id}`, {method:'POST'});
            const data = await res.json();
            if (data.success) {
                statusDiv.className = "mt-2 text-center status-ok";
                statusDiv.innerHTML = "‚úÖ Power cycle command sent";
            } else {
                statusDiv.className = "mt-2 text-center status-err";
                statusDiv.innerHTML = `‚ùå ${data.error}`;
            }
        } catch (e) {
            statusDiv.className = "mt-2 text-center status-err";
            statusDiv.innerHTML = "‚ùå Power cycle failed";
        } finally {
            btn.disabled = false;
        }
    }

    async function clearStorage() {
        const id = document.getElementById('nodeId').value;
        const statusDiv = document.getElementById('readStatus');
        const btn = document.getElementById('btnClearStorage');
        btn.disabled = true;
        statusDiv.className = "mt-2 text-center text-primary";
        statusDiv.innerHTML = "‚è≥ Clearing storage...";
        try {
            const res = await fetch(`/api/clear_storage/${id}`, {method:'POST'});
            const data = await res.json();
            if (data.success) {
                statusDiv.className = "mt-2 text-center status-ok";
                statusDiv.innerHTML = "‚úÖ Storage cleared";
            } else {
                statusDiv.className = "mt-2 text-center status-err";
                statusDiv.innerHTML = `‚ùå ${data.error || 'Clear storage failed'}`;
            }
        } catch (e) {
            statusDiv.className = "mt-2 text-center status-err";
            statusDiv.innerHTML = "‚ùå Clear storage failed";
        } finally {
            btn.disabled = false;
        }
    }

    async function applyConfig(isSafe) {
        const id = document.getElementById('nodeId').value;
        const rate = document.getElementById('sampleRate').value;
        const power = document.getElementById('txPower').value;
        const inputRangeRaw = document.getElementById('inputRange').value;
        const statusDiv = document.getElementById('writeStatus');
        if (!rate || Number.isNaN(parseInt(rate))) {
            statusDiv.className = "mt-3 text-center status-err";
            statusDiv.innerHTML = "‚ùå Sample Rate is unknown (N/A). Run FULL READ once or configure in SensorConnect.";
            return;
        }
        
        let activeChs = [];
        document.querySelectorAll('.ch-enable').forEach(cb => {
            if(cb.checked) { activeChs.push(parseInt(cb.id.replace('ch_', ''))); }
        });
        
        statusDiv.className = "mt-3 text-center text-primary";
        statusDiv.innerHTML = isSafe ? "‚è≥ Safe Write... –ø–æ–ø—ã—Ç–∫–∏ –∏ –ø–∞—É–∑—ã –≤–Ω—É—Ç—Ä–∏." : "‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        try {
            const res = await fetch('/api/write', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    node_id: id,
                    sample_rate: parseInt(rate),
                    tx_power: parseInt(power),
                    channels: activeChs,
                    input_range: inputRangeRaw === "" ? null : parseInt(inputRangeRaw)
                })
            });
            const data = await res.json();
            statusDiv.innerHTML = data.success ? "<span class='status-ok'>‚úÖ –£–°–ü–ï–®–ù–û –°–û–•–†–ê–ù–ï–ù–û</span>" : `<span class='status-err'>‚ùå ${data.error}</span>`;
        } catch (e) { }
    }

    function updateChannelSummary() {
        const all = document.querySelectorAll('.ch-enable');
        let active = 0;
        all.forEach(cb => { if (cb.checked) active += 1; });
        const btn = document.getElementById('channelSummaryBtn');
        if (btn) btn.innerText = `${active} active`;
    }

    function toggleChannelsMenu(event) {
        event.preventDefault();
        event.stopPropagation();
        const menu = document.getElementById('channelMenu');
        if (!menu) return;
        menu.classList.toggle('open');
    }

    document.addEventListener('click', function(evt) {
        const picker = document.getElementById('channelPicker');
        const menu = document.getElementById('channelMenu');
        if (!picker || !menu) return;
        if (!picker.contains(evt.target)) {
            menu.classList.remove('open');
        }
    });

    document.getElementById('nodeId').addEventListener('input', function() {
        const btn = document.getElementById('btnClearStorage');
        if (btn) btn.disabled = true;
    });

    async function refreshBaseStatus() {
        try {
            const res = await fetch('/api/status');
            const data = await res.json();
            const text = document.getElementById('baseStatusText');
            const pill = document.getElementById('baseStatusPill');
            if (data.connected) {
                pill.className = "status-pill status-ok-pill mb-3";
                pill.innerText = "Connected";
            } else {
                pill.className = "status-pill status-err-pill mb-3";
                pill.innerText = "Disconnected";
            }
            window.currentBeaconState = data.beacon_state;
            const beaconBtn = document.getElementById('btnBeacon');
            if (data.beacon_state === true) {
                beaconBtn.innerText = "Beacon: ON";
            } else if (data.beacon_state === false) {
                beaconBtn.innerText = "Beacon: OFF";
            } else {
                beaconBtn.innerText = "Beacon: ?";
            }
            const line1 = [
                `Status: ${data.message}`,
                `Port: ${data.port}`,
                `Last: ${data.ts || 'N/A'}`,
                data.base_model ? `Model: ${data.base_model}` : null,
                data.base_fw ? `FW: ${data.base_fw}` : null,
                data.base_serial ? `S/N: ${data.base_serial}` : null,
                data.base_connection ? `Connection: ${data.base_connection}` : null,
                data.base_region ? `Region: ${data.base_region}` : null,
                data.base_radio ? `Radio: ${data.base_radio}` : null
            ].filter(Boolean).join(" | ");
            const line2 = [
                data.base_last_comm ? `Last Comm: ${data.base_last_comm}` : null,
                data.base_link ? `State: ${data.base_link}` : null
            ].filter(Boolean).join(" | ");
            text.innerText = line2 ? `${line1}\n${line2}` : line1;
        } catch (e) { }
    }

    async function toggleBeacon() {
        try {
            const current = window.currentBeaconState;
            const target = (current === true) ? false : true;
            const res = await fetch('/api/beacon', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled: target})
            });
            const data = await res.json();
            const statusDiv = document.getElementById('readStatus');
            if (!data.success) {
                statusDiv.className = "mt-2 text-center status-err";
                statusDiv.innerHTML = `‚ùå ${data.error}`;
            } else {
                statusDiv.className = "mt-2 text-center status-ok";
                statusDiv.innerHTML = `‚úÖ ${data.message}`;
            }
            await refreshBaseStatus();
        } catch (e) { }
    }

    async function loadDiagnostics(id) {
        try {
            const res = await fetch(`/api/diagnostics/${id}`);
            const data = await res.json();
            const target = document.getElementById('diagFlags');
            if (!data.success) {
                target.innerText = "Diagnostics: " + data.error;
                return;
            }
            const parts = data.flags.map(f => `${f.name}: <span class='fw-bold'>${f.value ? 'YES' : 'NO'}</span>`);
            parts.push("<span class='fst-italic'>Feature flags may be conservative for this firmware/MSCL build.</span>");
            target.innerHTML = parts.join(" | ");
        } catch (e) { }
    }

    async function refreshLogs() {
        try {
            const res = await fetch('/api/logs');
            const data = await res.json();
            const box = document.getElementById('logBox');
            box.textContent = data.logs.join('\\n');
        } catch (e) { }
    }

    // Manual refresh only (no auto status refresh)
    refreshLogs();
</script>
</body>
</html>
