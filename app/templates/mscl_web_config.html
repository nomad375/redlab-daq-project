
<!DOCTYPE html>
<html>
<head>
    <title>TC-Link-200 Configurator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; font-family: sans-serif; }
        .card { margin-bottom: 20px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .status-ok { color: #2ecc71; font-weight: bold; }
        .status-err { color: #e74c3c; font-weight: bold; }
        .diag-text { font-size: 0.85rem; color: #6c757d; }
        .log-box { font-family: monospace; font-size: 0.8rem; background: #0b1020; color: #b9c2ff; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto; }
        .status-pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.8rem; }
        .status-ok-pill { background: #dff6e8; color: #1f7a3f; }
        .status-err-pill { background: #fde2e1; color: #b3261e; }
        .base-status-text { white-space: pre-line; }
    </style>
</head>
<body>
<div class="container" style="max-width: 800px;">
    <div class="card p-3 shadow-sm bg-primary text-white d-flex flex-row justify-content-between align-items-center">
        <h4 class="m-0">üì° –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä TC-Link-200</h4>
    </div>

    <div class="card p-4 shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <div class="fw-bold">BaseStation</div>
                <div id="baseStatusText" class="small text-muted base-status-text">Status: Unknown</div>
            </div>
            <div class="d-flex gap-2">
                <button onclick="connectBase()" class="btn btn-outline-secondary btn-sm fw-bold">üîå Connect & Refresh</button>
                <button onclick="reconnectBase()" class="btn btn-outline-warning btn-sm fw-bold">üîÅ Reconnect</button>
            </div>
        </div>
        <div id="baseStatusPill" class="status-pill status-err-pill mb-3">Disconnected</div>

        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text">Node ID</span>
                    <input type="number" id="nodeId" class="form-control" value="16907">
                </div>
            </div>
            <div class="col-md-8 d-flex gap-2">
                <button id="btnRead" onclick="readConfig(true)" class="btn btn-success w-100 fw-bold">üõ°Ô∏è SAFE READ</button>
                <button id="btnProbe" onclick="probeNode()" class="btn btn-outline-secondary fw-bold">üõ∞Ô∏è PROBE</button>
            </div>
        </div>
        <div id="readStatus" class="mt-2 text-center fw-bold small"></div>
    </div>

    <div id="configCard" style="display:none;">
        <div class="card p-4 shadow-sm">
            <div class="fw-bold text-primary mb-3">
                Node Settings
                <span class="ms-2 text-muted" title="LED quick guide: Green pulse = Idle. Single green blink every ~2s = Sampling. Blue during sampling = resynchronizing. Red = self-test error. Off = powered down.">‚ìò</span>
            </div>
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold">–ß–∞—Å—Ç–æ—Ç–∞ (Sample Rate)</label>
                    <select id="sampleRate" class="form-select"></select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">–ú–æ—â–Ω–æ—Å—Ç—å —Ä–∞–¥–∏–æ</label>
                    <select id="txPower" class="form-select">
                        <option value="20">20 dBm (Max)</option>
                        <option value="16">16 dBm</option>
                        <option value="10">10 dBm</option>
                        <option value="5">5 dBm</option>
                        <option value="0">0 dBm (Min)</option>
                    </select>
                </div>
            </div>

            <label class="form-label fw-bold text-primary">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (Raw Mode):</label>
            <div id="channelsArea" class="mb-4"></div>

            <div class="mb-3">
                <div class="fw-bold text-primary mb-1">Node Status</div>
                <div id="diagArea" class="diag-text p-2 bg-light rounded"></div>
            </div>
            <div class="mb-4">
                <div class="fw-bold text-primary mb-1">Node Diagnostics</div>
                <div id="diagFlags" class="small text-muted"></div>
            </div>

            <button id="btnWrite" onclick="applyConfig(true)" class="btn btn-primary w-100 fw-bold py-2">üõ°Ô∏è SAFE WRITE</button>
            <div id="writeStatus" class="mt-3 text-center fw-bold"></div>
        </div>
    </div>

    <div class="card p-4 shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">MSCL Logs</div>
            <button onclick="refreshLogs()" class="btn btn-outline-secondary btn-sm fw-bold">‚Üª Refresh</button>
        </div>
        <div id="logBox" class="log-box">Logs will appear here‚Ä¶</div>
    </div>
</div>

<script>
    async function connectBase() {
        try {
            const res = await fetch('/api/connect', {method:'POST'});
            const data = await res.json();
            await refreshBaseStatus();
        } catch (e) { }
    }

    async function readConfig(isSafe) {
        const id = document.getElementById('nodeId').value;
        const statusDiv = document.getElementById('readStatus');
        const btn = document.getElementById('btnRead');
        
        btn.disabled = true;
        statusDiv.className = "mt-2 text-center text-primary";
        statusDiv.innerHTML = isSafe ? "‚åõ Safe Read... –ø–æ–ø—ã—Ç–∫–∏ –∏ –ø–∞—É–∑—ã –≤–Ω—É—Ç—Ä–∏." : "‚åõ –ß—Ç–µ–Ω–∏–µ...";
        document.getElementById('configCard').style.display = "none";
        
        try {
            const res = await fetch(`/api/read/${id}`);
            const data = await res.json();
            if(data.success) {
                statusDiv.className = "mt-2 text-center status-ok";
                statusDiv.innerHTML = "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã";
                document.getElementById('configCard').style.display = "block";
                
                document.getElementById('txPower').value = data.current_power;
                const statusParts = [
                    `Model: ${data.model}`,
                    `FW: ${data.fw}`,
                    `S/N: ${data.sn}`,
                    data.region ? `Region: ${data.region}` : null,
                    data.last_comm ? `Last Comm: ${data.last_comm}` : null,
                    data.state ? `State: ${data.state}` : null,
                    (data.storage_pct !== null && data.storage_pct !== undefined) ? `Storage: ${data.storage_pct}%` : null,
                    data.sampling_mode ? `Sampling: ${data.sampling_mode}` : null,
                    data.data_mode ? `Data Mode: ${data.data_mode}` : null
                ].filter(Boolean);
                document.getElementById('diagArea').innerHTML = statusParts.join(" | ");
                await loadDiagnostics(id);

                const sel = document.getElementById('sampleRate');
                sel.innerHTML = "";
                if (data.current_rate === null || data.current_rate === undefined) {
                    let opt = document.createElement('option');
                    opt.value = "";
                    opt.text = "N/A";
                    opt.selected = true;
                    sel.add(opt);
                }
                data.supported_rates.forEach(r => {
                    let opt = document.createElement('option');
                    opt.value = r.enum_val; opt.text = r.str_val;
                    if(r.enum_val == data.current_rate) opt.selected = true;
                    sel.add(opt);
                });

                const chArea = document.getElementById('channelsArea');
                chArea.innerHTML = "";
                data.channels.forEach(ch => {
                    let checked = ch.enabled ? "checked" : "";
                    chArea.innerHTML += `
                        <div class="border rounded p-2 mb-2 bg-white d-flex justify-content-between align-items-center">
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input ch-enable" type="checkbox" id="ch_${ch.id}" ${checked}>
                                <label class="form-check-label fw-bold">–ö–∞–Ω–∞–ª ${ch.id}</label>
                            </div>
                        </div>`;
                });
            } else {
                statusDiv.className = "mt-2 text-center status-err";
                statusDiv.innerHTML = "‚ùå –û—à–∏–±–∫–∞: " + data.error;
            }
        } finally { btn.disabled = false; }
    }

    async function probeNode() {
        const id = document.getElementById('nodeId').value;
        const statusDiv = document.getElementById('readStatus');
        const btn = document.getElementById('btnProbe');
        btn.disabled = true;
        statusDiv.className = "mt-2 text-center text-primary";
        statusDiv.innerHTML = "üõ∞Ô∏è Probing node...";
        try {
            const res = await fetch(`/api/probe/${id}`);
            const data = await res.json();
            if (data.success) {
                statusDiv.className = "mt-2 text-center status-ok";
                statusDiv.innerHTML = `‚úÖ ${data.message || 'Probe OK'}`;
            } else {
                statusDiv.className = "mt-2 text-center status-err";
                statusDiv.innerHTML = `‚ùå ${data.error || 'Probe failed'}`;
            }
        } catch (e) {
            statusDiv.className = "mt-2 text-center status-err";
            statusDiv.innerHTML = "‚ùå Probe failed";
        } finally {
            btn.disabled = false;
        }
    }

    async function applyConfig(isSafe) {
        const id = document.getElementById('nodeId').value;
        const rate = document.getElementById('sampleRate').value;
        const power = document.getElementById('txPower').value;
        const statusDiv = document.getElementById('writeStatus');
        
        let activeChs = [];
        document.querySelectorAll('.ch-enable').forEach(cb => {
            if(cb.checked) { activeChs.push(parseInt(cb.id.replace('ch_', ''))); }
        });
        
        statusDiv.className = "mt-3 text-center text-primary";
        statusDiv.innerHTML = isSafe ? "‚è≥ Safe Write... –ø–æ–ø—ã—Ç–∫–∏ –∏ –ø–∞—É–∑—ã –≤–Ω—É—Ç—Ä–∏." : "‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        try {
            const res = await fetch('/api/write', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ node_id: id, sample_rate: parseInt(rate), tx_power: parseInt(power), channels: activeChs })
            });
            const data = await res.json();
            statusDiv.innerHTML = data.success ? "<span class='status-ok'>‚úÖ –£–°–ü–ï–®–ù–û –°–û–•–†–ê–ù–ï–ù–û</span>" : `<span class='status-err'>‚ùå ${data.error}</span>`;
        } catch (e) { }
    }

    async function refreshBaseStatus() {
        try {
            const res = await fetch('/api/status');
            const data = await res.json();
            const text = document.getElementById('baseStatusText');
            const pill = document.getElementById('baseStatusPill');
            if (data.connected) {
                pill.className = "status-pill status-ok-pill mb-3";
                pill.innerText = "Connected";
            } else {
                pill.className = "status-pill status-err-pill mb-3";
                pill.innerText = "Disconnected";
            }
            const line1 = [
                `Status: ${data.message}`,
                `Port: ${data.port}`,
                `Last: ${data.ts || 'N/A'}`,
                data.base_model ? `Model: ${data.base_model}` : null,
                data.base_fw ? `FW: ${data.base_fw}` : null,
                data.base_serial ? `S/N: ${data.base_serial}` : null,
                data.base_region ? `Region: ${data.base_region}` : null,
                data.base_radio ? `Radio: ${data.base_radio}` : null
            ].filter(Boolean).join(" | ");
            const line2 = [
                data.base_last_comm ? `Last Comm: ${data.base_last_comm}` : null,
                data.base_link ? `State: ${data.base_link}` : null
            ].filter(Boolean).join(" | ");
            text.innerText = line2 ? `${line1}\n${line2}` : line1;
        } catch (e) { }
    }

    async function reconnectBase() {
        try {
            await fetch('/api/reconnect', {method:'POST'});
            await refreshBaseStatus();
        } catch (e) { }
    }

    async function loadDiagnostics(id) {
        try {
            const res = await fetch(`/api/diagnostics/${id}`);
            const data = await res.json();
            const target = document.getElementById('diagFlags');
            if (!data.success) {
                target.innerText = "Diagnostics: " + data.error;
                return;
            }
            target.innerHTML = data.flags.map(f => `${f.name}: <span class='fw-bold'>${f.value ? 'YES' : 'NO'}</span>`).join(" | ");
        } catch (e) { }
    }

    async function refreshLogs() {
        try {
            const res = await fetch('/api/logs');
            const data = await res.json();
            const box = document.getElementById('logBox');
            box.textContent = data.logs.join('\\n');
        } catch (e) { }
    }

    // Manual refresh only (no auto status refresh)
    refreshLogs();
</script>
</body>
</html>
